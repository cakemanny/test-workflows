on:
  issue_comment:
    types: [created, edited, deleted]

#permissions:
#  contents: write
#  issues: write  # to react to comment (doesn't work)
#  pull-requests: read  # to find out head branch

jobs:
  fake-it:
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/trigger') }}
    runs-on: ubuntu-latest
    env:
      # for using gh cli
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: React with ðŸ‘€
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
             -f "content=eyes"
      - name: Work out head branch
        id: find-branch
        run: |
          echo "${{ github.event.issue.pull_request.url }}"
          HEAD_REF=$(
            gh api -X GET \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/pulls/${{ github.event.issue.id }} \
              --jq '.head.ref'
          )
          echo "HEAD_REF=$HEAD_REF" >> "$GITHUB_OUTPUT"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.find-branch.outputs.HEAD_REF }}
      - run: |
          git branch -v
      - run: |
          # React with +1
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
             -f "content=+1"
      - if: ${{ always() }}
        run: |
          gh api \
            -X GET \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content=eyes \
            --jq '.[] | select(.user.login == "github-actions[bot]") | .id' \
          | head -1 | while read REACTION_ID; do
            gh api \
              -X DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              /repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions/"${REACTION_ID}"
          done
